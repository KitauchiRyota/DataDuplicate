<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <title>データ複製App</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <h1>データ複製App</h1>

  <form id="duplicate-data">
  <ol>
    <li><label for="origin-data">元となるデータのURL：</label>
    <input id="origin-data" type="text" required>
    <!-- Todo：アクセス権、有効なURLかなどのバリデーション -->

    <li><label for="qty">作りたい個数</label>
    <br>

    <label><input type="radio" name="qty-desig" value="qty-num">A.個数を指定して作成</label>
    <div id='qty-num-options' class='qty-opt' style='display:none;'>
    <ul>
      <li><label>新たに作る個数：<input id="qty-num" type="number" min=1></label><br>
      <li><label>（任意）コピー後のデータ名：<input id="dest-name" type="texet"></label>
      <div>コピー後のデータ名を指定したい場合は、入力してください。空欄の場合、「（元のデータ名）_コピー1」の形式で、末尾の数字がカウントアップされます。<br>また、ここで入力するデータ名の「★」の位置を、下で選んだ規則で置き換えることができます。「★」は使用しなくてもかまいません。<br>※この方法で複製する場合、データ名に含まれる「★」は、必ず下の規則で置き換わります。</div>
      <label><input type="radio" name="rule-type" value="num" checked>1、2、3、・・・</label><br>
      <label><input type="radio" name="rule-type" value="alp">A、B、C・・・</label><br>
    </ul>
    </div>

    <br>
    <label><input type="radio" name="qty-desig" value="list">B.リスト分作成</label>
    <div id='qty-list-options' class='qty-opt' style='display:none;'>
      <label>リストを入力（改行で区切ります）<textarea id="qty-list"></textarea></label>
    </div>
    <!-- Todo：数値か、空欄かなどバリデーション -->

    <li><label for="data-dest">複製先のフォルダ元のURL：</label>
    <input id="data-dest" type="text"><div>※空欄の場合、元データと同じ場所に複製します。</div>
    <!-- Todo：元データのURLで初期化 -->

    <!-- <li><label for="rule-type">複製後のデータ名に規則性を設定する：</label><input type="checkbox"><br> -->
    <!-- Todo：チェックボックスをクリックすると以降の選択肢が表示されるように、それまでは非表示に -->
    
    <!-- <input id="data-name" type="text" value="★" required><br> -->
    <!-- <div>※「★」の位置が、下で選んだ規則で置き換わります。この方法で複製する場合、データ名に「★」を含めることはできません。</div> -->
    <!-- Todo：★の数（0個も許しても良い。）、Googleドライブ側のデータ名に使える文字のルールについて、 -->

    <!-- <label for="rule-num"><input id="rule-num" type="radio" name="rule-type" value="num" required>1、2、3、・・・</label><br>
    <label for="rule-alp"><input id="rule-alp" type="radio" name="rule-type" value="alp">A、B、C・・・</label><br>
    <label for="rule-any"><input id="rule-any" type="radio" name="rule-type" value="any">ユーザー定義</label>
    <input id="user-defined-rule" type="text"><br> -->
    <!-- Todo：ユーザー定義のラジオを選択すると選択肢が表示されるように、それまでは非表示。どれも選んでない状態はエラーを出す。 -->
    
    <button type="submit">複製</button>
    <div id="status"></div>
  </ol>
  </form>

  <div id="statusMessage"></div>

  <script>

    // 複製方法の選択によって表示を変更
    const radios = document.querySelectorAll('input[name="qty-desig"]');
    const qtyNumDiv = document.getElementById('qty-num-options');
    const qtyListDiv = document.getElementById('qty-list-options');
    radios.forEach(radio => {
      radio.addEventListener('change',()=>{
        if(radio.value === 'qty-num'){
          qtyNumDiv.style.display = 'block';
          qtyListDiv.style.display = 'none';      
        }else if(radio.value === 'list'){
          qtyNumDiv.style.display = 'none';
          qtyListDiv.style.display = 'block';
        }else{
          qtyNumDiv.style.display = 'none';
          qtyListDiv.style.display = 'none';
        }
      })
    });

    /**
     * 数値を、Aからの個数に対応するアルファベット（26以上は、「AA、AB、・・・」の形式）に変換する関数
     * @param {integer} n 変換元の数値
     * @return {string} result 変換後のアルファベットの文字列
     */
    function numToAlp(n) {
      let result ='';
      while (n > 0) {
        n--; 
        result = String.fromCharCode(65 + (n % 26)) + result;
        n = Math.floor(n / 26);
      }
      return result;
    }

    /**
     * 複製方法から、データの個数・データ名の配列のオブジェクトを返す関数
     * @param {string} desig 複製方法（inputのvalue）
     * @return {object} 複製方法、データの個数、データ名の配列を格納しているオブジェクト
    */
    function createDestNameObject(desig){

      let nameArray = [];

      switch(desig){
        case 'qty-num': // 個数を指定して複製の場合

          const qty = document.getElementById('qty-num').value;
          const destName = document.getElementById('dest-name').value.trim();

          if(destName){ // データ名が入力されている場合
          // Todo:アルファベット置き換えの「★」処理

          const nameRule = document.querySelector('input[name="rule-type"]:checked').value;

          switch(nameRule){
            case 'num':
              for(let i=0 ; i<qty ; i++){
                nameArray.push(destName.replace('★',i+1));
              }
              break;
            case 'alp':
              for(let i=0 ; i<qty ; i++){
                nameArray.push(destName.replace('★',numToAlp(i+1)));
              }
              break;
          }

            return {
              qtyDesig: 'num-and-name',
              qty: qty,
              destNames: nameArray
            };

          }else{ // データ名が空白文字の時
            return {
              qtyDesig: 'num-only',
              qty: qty,
              destNames: nameArray
            };
          }
          break;
        
        case 'list': // リストから複製の場合
          const qtyList = document.getElementById('qty-list').value;
          // 改行で分割し、空白文字の行を除去
          nameArray = qtyList
            .split("\n")
            .map(name => name.trim())
            .filter(name => name !== "");

          console.log('list :' + nameArray);
          console.log('type of list ;' + typeof(nameArray));

          return {
            qtyDesig: 'list',
            qty: nameArray.length,
            destNames: nameArray
          };
          break;
      }
    }

    const statusDiv = document.getElementById('status');
    const duplicateDataForm = document.getElementById('duplicate-data');

    duplicateDataForm.addEventListener('submit',async(e) =>{
      e.preventDefault();

      const selectedDesig = document.querySelector('input[name="qty-desig"]:checked');

      if(!selectedDesig){
        alert('複製方法を選択して下さい！');
        return;
      }

      const nameObj = createDestNameObject(selectedDesig.value);
      console.log(nameObj.qty);
      console.log(nameObj.qtyDesig);
      console.log(nameObj.destNames);

      statusDiv.textContent = '';
      const srcUrl = document.getElementById('origin-data').value.trim();
      const destUrl = document.getElementById('data-dest').value.trim();

      // console.log(inputUrl + ',' + typeof(inputUrl));
      // duplicationTest(srcUrl, nameObj, destUrl);
    })

    function duplicationTest(srcUrl, qty, nameArray, destUrl){
      google.script.run.withSuccessHandler(res =>{
        console.log(res);
        statusDiv.textContent = res;
      })
      .withFailureHandler(err => {
        console.error(err);
        return err;
      }).main(srcUrl, nameObj, destUrl);
    }


    // （参考用）以降は議事録送信プログラム

    const selectElement = document.getElementById('weekdaySelect');
    const statusMessageDiv = document.getElementById('statusMessage');

    /**
     * 送信ボタンが押されたときにGAS関数を呼び出す
     */
    function sendMinute() {
      const selectedValue = selectElement.value; // 選択されたoptionのvalueを取得

      // エラーメッセージとステータスをクリアし、ローディングを表示
      statusMessageDiv.innerText = '';
      // errorMessageDiv.innerText = '';
      // loadingIndicator.style.display = 'block';

      if (selectedValue) { // 何か選択された場合のみGASを呼び出す
        google.script.run
          .withSuccessHandler(function(mes) {
            // 成功した場合の処理
            statusMessageDiv.innerText = mes+"送信しました！";
            // loadingIndicator.style.display = 'none'; // ローディング非表示
            // setTimeout(() => statusMessageDiv.innerText = '', 3000); // 3秒後にメッセージを消す
          })
          .withFailureHandler(function() {
            // 失敗した場合の処理
            statusMessageDiv.innerText = "エラー：送信できませんでした";
            // errorMessageDiv.innerText = 'エラー: ' + error.message;
            // loadingIndicator.style.display = 'none'; // ローディング非表示
          })
          .getGreetingMessage(selectedValue); // GASの関数と選択値を引数として渡す
      } else {
        // 「選択してください」が選ばれた場合などの処理
        statusMessageDiv.innerText = 'クラスを選択してください。';
        // loadingIndicator.style.display = 'none';
      }
    }

  </script>
</body>

</html>